# 일일 업무 정리

**날짜:** 2025년 11월 12일  
**프로젝트:** SANDI APP-Management System

---

## 📋 작업 개요

localhost:3310에서 네이버 지도가 렌더링되지 않는 문제 해결

---

## 🔍 문제 상황

### 증상
- **localhost:3300**: 네이버 지도 정상 작동 
- **localhost:3310**: 네이버 지도 렌더링 실패 ❌
- 동일한 코드임에도 불구하고 포트별로 다른 동작

### 에러 메시지
```
GET https://nrbe.map.naver.net/styles/basic@2x.json?fmt=png 
net::ERR_CONNECTION_RESET

GET https://nrbe.map.naver.net/styles/terrain@2x.json?fmt=png 
net::ERR_CONNECTION_RESET

Failed to load resource: net::ERR_CONNECTION_CLOSED
```

### 콘솔 로그
- "Map is not ready yet." 반복 출력
- 지도 타일 이미지 로딩 실패
- `window.naver.maps` 객체는 존재하나 `jsContentLoaded: false` 상태

---

## 🛠️ 시도한 해결 방법

### 1. 스크립트 로딩 방식 검토
- **기존**: useEffect에서 동적으로 스크립트 로드
- **수정**: index.html에 정적 스크립트 태그로 변경
  ```html
  <script type="text/javascript" 
          src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=b28jyf2lae">
  </script>
  ```

### 2. 스크립트 로드 완료 대기 로직 개선
```javascript
useEffect(() => {
  const checkInterval = setInterval(() => {
    if (window.naver?.maps?.Map) {
      setIsMapScriptLoaded(true);
      clearInterval(checkInterval);
    }
  }, 100);

  return () => clearInterval(checkInterval);
}, []);
```

### 3. 네트워크 환경 테스트
- 다른 네트워크(모바일 핫스팟) 테스트 → 동일한 문제 발생
- 브라우저 직접 URL 접속 테스트
- Network 탭 상세 분석

---

## ✅ 최종 해결 방법

### 원인
**Content-Security-Policy (CSP) 메타 태그**가 문제였음

```html
<!-- 문제가 된 코드 -->
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"/>
```

이 태그가 모든 HTTP 요청을 HTTPS로 강제 변환하면서:
1. 네이버 지도 API의 일부 HTTP 리소스 요청 차단
2. HTTPS 변환 실패로 `ERR_CONNECTION_RESET` 발생
3. 지도 타일 이미지 로딩 실패

### 해결
CSP 메타 태그 주석 처리

```html
<!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"/> -->
```

---

## 📝 수정된 파일

### `public/index.html`

**제거/주석 처리:**
- ❌ Content-Security-Policy 메타 태그
- ❌ Expires 메타 태그 (중복)

**최종 코드:**
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    
    <!-- Cache-control -->
    <meta http-equiv="Cache-Control" 
          content="no-cache, no-store, must-revalidate"/>
    
    <!-- Naver Map Script -->
    <script type="text/javascript" 
            src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=b28jyf2lae">
    </script>
    
    <!-- CSP 주석 처리 -->
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"/> -->
    
    <title>SANDI APP-Management System</title>
</head>
<body>
    <div id="root"></div>
</body>
</html>
```

### `src/components/NaverMapComponent/index.tsx`

**변경 사항:**
- 동적 스크립트 로딩 로직 제거
- interval 체크로 지도 API 로드 완료 대기

```javascript
useEffect(() => {
  // HTML에 이미 로드되어 있으므로 interval로 체크
  const checkInterval = setInterval(() => {
    if (window.naver?.maps?.Map) {
      setIsMapScriptLoaded(true);
      clearInterval(checkInterval);
    }
  }, 100);

  return () => clearInterval(checkInterval);
}, []);
```

---

## 📚 학습 내용

### CSP (Content Security Policy)란?
- 웹 보안을 위한 정책으로, 리소스 로딩을 제한
- `upgrade-insecure-requests`: 모든 HTTP를 HTTPS로 강제 변환
- 외부 API와의 호환성 문제 발생 가능

### CSP 사용 권장사항
- **개발 환경**: CSP 제거 또는 주석 (개발 편의성)
- **프로덕션**: 웹서버(Nginx, Apache)에서 HTTP 헤더로 관리
- HTML 메타 태그보다 서버 헤더 설정이 더 유연함

### 네이버 지도 API 로딩 프로세스
1. 스크립트 로드 (`maps.js`)
2. `window.naver.maps` 객체 생성
3. `jsContentLoaded: true`로 변경
4. 실제 지도 클래스(`Map`, `Marker` 등) 사용 가능

---

## 🎯 결과

✅ localhost:3310에서 네이버 지도 정상 렌더링  
✅ 지도 타일 이미지 로딩 성공  
✅ 마커 및 폴리곤 기능 정상 작동  

---

## 💡 개선 제안

### 1. 타임아웃 추가
무한 interval 방지를 위한 타임아웃 로직 추가:

```javascript
useEffect(() => {
  let checkInterval: NodeJS.Timeout;
  let timeout: NodeJS.Timeout;

  timeout = setTimeout(() => {
    clearInterval(checkInterval);
    setScriptError("지도 로딩 시간이 초과되었습니다.");
  }, 10000);

  checkInterval = setInterval(() => {
    if (window.naver?.maps?.Map) {
      setIsMapScriptLoaded(true);
      clearInterval(checkInterval);
      clearTimeout(timeout);
    }
  }, 100);

  return () => {
    clearInterval(checkInterval);
    clearTimeout(timeout);
  };
}, []);
```

### 2. 프로덕션 배포 시 체크리스트
- [ ] 모든 외부 리소스 HTTPS 확인
- [ ] 웹서버에서 CSP 헤더 설정
- [ ] 네이버 클라우드 콘솔에서 배포 도메인 등록 확인

---

## 🔗 참고 자료

- [네이버 지도 API 문서](https://navermaps.github.io/maps.js.ncp/)
- [MDN - Content Security Policy](https://developer.mozilla.org/ko/docs/Web/HTTP/CSP)
- 프로젝트 파일: `src/components/NaverMapComponent/index.tsx`

---

## 📌 메모

- 같은 코드라도 HTML 설정(특히 보안 정책)에 따라 동작이 달라질 수 있음
- 외부 API 사용 시 CSP 설정 주의 필요
- localhost 포트가 달라도 문제가 아니었음 - HTML 메타 태그 차이가 원인
