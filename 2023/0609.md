## ğŸ“† 2023-06-09 (ê¸ˆ)
### ğŸ”¥ ì˜¤ëŠ˜ í•œ ì¼ <br>

### serversidePropsì—ì„œ ì²˜ë¦¬ ì™„ë£Œ.

```getServerSide```í•¨ìˆ˜ì—ì„œ axios instace, inspectorê°€ ì•ˆë¨ì„ ì•Œê³ ,
ì½”ë“œê°€ ê¸¸ê¸´ í•˜ì§€ë§Œ fetch ì²˜ë¦¬ë¡œ ì›í•˜ëŠ”ë°”ë¥¼ ì´ë£°ìˆ˜ ìˆì—ˆë‹¤.

1. ```getSession```ì„ ì´ìš©í•´ _ì„œë²„ì‚¬ì´ë“œ_ ì—ì„œ ì„¸ì…˜ì •ë³´(í† í°)ì„ ë¶ˆëŸ¬ì˜¤ê³ ,  
ê·¸ê²ƒì„ headerì— ë‹´ê³ , apië¥¼ í˜¸ì¶œí•œë‹¤. 

2. í† í°ì´ ë§Œë£Œë˜ë©´ refresh apië¥¼ ìš”ì²­í•´ ìƒˆ ```accessToken``` ì„ ë°›ê³ , ì¬ìš”ì²­í•œë‹¤

ì•Œê²Œ ëœ ì  : serverSidePropsì—ì„œëŠ” try, catchì™€ fetchí•¨ìˆ˜ë¡œ ì²˜ë¦¬í•´ì•¼ í•˜ê³ , ê°’ì„ ê¼­ return í•´ì•¼ í•œë‹¤. 

```js

import { getSession } from 'next-auth/react';
import type { NextPage } from 'next';

const Testtest: NextPage = ({ repo, refreshResult, newTokenResponse }) => {
  console.log('repo ', repo);
  console.log('refreshResult', refreshResult);
  console.log('newTokenResponse', newTokenResponse);

  return (
    <>
      <span>ë§Œë£Œ ì „ ìš”ì²­</span>
      <pre>{JSON.stringify(repo, null, 2)}</pre>
      <hr />
      <span>ìƒˆë¡œìš´ í† í°ìœ¼ë¡œ ìš”ì²­:</span>
      <pre>{JSON.stringify(newTokenResponse, null, 2)}</pre>
      <hr />
    </>
  );
};

export default Testtest;

export async function getServerSideProps({ req }) {
  const session = await getSession({ req });

  try {
    const result = await fetch(`${process.env.NEXT_PUBLIC_API_BASE_URL}/login-service/userInfo/getUserInfo`, {
      method: 'post',
      headers: {
        Authorization: session.accessToken,
      },
    });
    const repo = await result.json();
    if (result.status === 401) {
      console.log('401ì²˜ë¦¬');
      try {
        const goRefresh = await fetch(`${process.env.NEXT_PUBLIC_API_BASE_URL}/login-service/auth/refresh`, {
          method: 'post',
          headers: {
            'Content-Type': 'application/json',
            Authorization: session.accessToken,
          },
          body: JSON.stringify({ refreshToken: session.refreshToken }),
        });
        const refreshResult = await goRefresh.json();
        console.log('refreshResult', refreshResult);

        if (refreshResult.resultMessage === 'ACCESS TOKENì„ ì¬ë°œí–‰ í•˜ì˜€ìŠµë‹ˆë‹¤.') {
          // ìƒˆë¡œìš´í† í°ìœ¼ë¡œ getuserInfo ì¬ìš”ì²­
          console.log('ìƒˆë¡œìš´í† í°ìœ¼ë¡œ getuserInfo ì¬ìš”ì²­');
          const newToken = refreshResult.accessToken;
          try {
            const newRequest = await fetch(
              `${process.env.NEXT_PUBLIC_API_BASE_URL}/login-service/userInfo/getUserInfo`,
              {
                method: 'post',
                headers: {
                  Authorization: newToken,
                },
              }
            );
            const newTokenResponse = await newRequest.json();
            console.log('newTokenResponse', newTokenResponse);
            return {
              props: { newTokenResponse },
            };
          } catch (newTokenErr) {
            console.log('newTokenErr', newTokenErr);
          }
        }
        return { props: { refreshResult } };
      } catch (err) {
        console.log('401 err', err);
      }
    }
    return { props: { repo } };
  } catch (err) {
    console.log('try ì‹¤íŒ¨', err);
    return { props: { object: '123' } };
  }
}


```

## client sideì—ì„œ axios instanceë¡œ refreshToken ì‚¬ìš©í•˜ê¸°

ì»´í¬ë„ŒíŠ¸ ì•ˆì—ì„œ í•¨ìˆ˜ í˜¸ì¶œì‹œì—” axios instanceì™€ inspectorë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì„œ ë„ë¦¬ì–´ ê°„í¸í–ˆë‹¤.
ì´ê²ƒì„ ì„œë²„ì‚¬ì´ë“œì—ì„œ ì“¸ìˆ˜ ì—†ì–´ì„œ ì•„ì‰½ë‹¤. 

ìœ„ì˜ í•¨ìˆ˜ë¥¼ ëª¨ë“ˆí™”í•´ì„œ ì“°ëŠ” ë°©ì•ˆì„ ìƒê°í•´ì•¼ê² ë‹¤. 

#### axiosConfig.ts

```js
/* eslint-disable */
'use client';

import axios from 'axios';
import {useSession} from 'next-auth/react';

// axios.defaults.baseURL = process.env.NODE_ENV === 'development' ? '' : process.env.NEXT_PUBLIC_API_BASE_URL;
// axios.defaults.baseURL = process.env.API_URL;

const axiosAuth = axios.create({
    baseURL: process.env.NEXT_PUBLIC_API_BASE_URL,
    withCredentials: true,
});

const useRefreshToken = () => {
    const {data: session} = useSession();
    // const session = async () => getServerSession(req, res, authOptions);

    const requestRefreshToken = async () => {
        console.log('3ë¦¬í”„ë ˆì‹œ ì‹¤í–‰');
        const res = await axiosAuth.post(
            `/login-service/auth/refresh`, // token refresh api
            {refreshToken: `${session.refreshToken}`},
            {headers: {Authorization: `Bearer ${session.accessToken}`}}
        );
        console.log('3 res?', res);
        // refresh ê²°ê³¼ëŠ” 2 response ê²°ê³¼ë¡œ ì°íŒë‹¤
    };
    return requestRefreshToken;
};

export const useAxiosAuth = () => {
    const {data: session} = useSession();
    // const session = async () => getServerSession(req, res, authOptions);

    const getRefreshToken = useRefreshToken();

    // useEffect(() => {
    // ìš”ì²­ ì¸í„°ì…‰í„°
    const requestIntercept = axiosAuth.interceptors.request.use(
        (config) => {
            if (!config.headers.Authorization) {
                console.log('1ìš”ì²­ ë³´ë‚´ëŠ” session', session);
                console.log('1ìš”ì²­ ë³´ë‚´ëŠ” accessToken', session.accessToken);
                config.headers.Authorization = `${session.accessToken}`;
            }
            return config;
        },
        (error) => {
            console.log('1 interceptor request error', error);
            Promise.reject(error);
        }
    );

    // ì‘ë‹µ ì¸í„°ì…‰í„°
    const responseIntercept = axiosAuth.interceptors.response.use(
        (response) => {
            console.log('2 Interceptors response', response);

            // ì¬ë°œí–‰ ë°›ì€ í† í° ë®ì–´ì“°ê¸°
            if (response?.data?.resultMessage?.includes('ì¬ë°œí–‰')) {
                session.accessToken = response.data.accessToken;
            }

            return response;
        },
        async (error) => {
            const prevRequest = error?.config;
            if (error?.response?.status === 401 && !prevRequest?.sent) {
                prevRequest.sent = true;
                await getRefreshToken();
                prevRequest.headers.Authorization = `${session?.accessToken}`;
                return axiosAuth(prevRequest);
            }
            return Promise.reject(error);
        }
    );
    //
    //   return () => {
    //     axiosAuth.interceptors.request.eject(requestIntercept);
    //     axiosAuth.interceptors.response.eject(responseIntercept);
    //   };
    // }, [session, refreshToken]);

    return axiosAuth;
};

export default axiosAuth;

```


#### Test.tsx (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ)
ì»´í¬ë„ŒíŠ¸ ì•ˆì—ì„œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬, ì´ê²ƒì´ ìœ„ì˜ axiosConfig.tsë¥¼ íƒ„ë‹¤. 

```js

'use client';

import React, { useState } from 'react';
import { useAxiosAuth } from '~/services/axiosConfig';
import { useSession } from 'next-auth/react';

const Test = () => {
  const axiosAuth = useAxiosAuth();
  const { data: session } = useSession();

  const [userData, setUserData] = useState();
  console.log('TESTpage session', session);

  const getUserInfo = () => {
    console.log('í´ë¦­');
    axiosAuth({
      method: 'post',
      url: '/login-service/userInfo/getUserInfo',
    })
      .then((response) => {
        console.log('test response', response);
        setUserData(response.data.data);
      })
      .catch((err) => {
        console.log('test err', err);
      });
  };

  console.log('userData', userData);

  return (
    <>
      <a onClick={getUserInfo}>getUserInfo</a>
    </>
  );
};
export default Test;

```




