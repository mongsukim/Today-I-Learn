## ğŸ“† 2023-05-31 (ìˆ˜)
### ğŸ”¥ ì˜¤ëŠ˜ í•œ ì¼ <br>

ì¼ì£¼ì¼ ë„˜ê²Œ êµ¬í˜„í•˜ëŠë¼ ì• ì¼ë˜ ```next-auth``` + ```axios interceptor```ë¡œ í† í° ë¡œí…Œì´ì…˜ ê¸°ëŠ¥ ì™„ë£Œ! 

#### ì´ë²ˆì— ë§Œë“  ê¸°ëŠ¥ :   

ìƒˆë¡œ ë°›ì•„ì˜¨ refresh í† í°ë‚´ìš©ì„  
nextauth Credentialì˜ sessionì— ì—…ë°ì´íŠ¸   

```js
if (response?.data?.massage?.includes('ì¬ë°œí–‰')) {
          session.accessToken = response.data.data;
        }
```

#### í˜ë“¤ì—ˆë˜ ì½”ë“œ

ë¦¬í”„ë ˆì‹œ í† í°ì„ ì–»ì€ ê²°ê³¼ê°’ì´ 
ì‘ë‹µ ì¸í„°ì…‰í„°ì˜ responseê°’ìœ¼ë¡œë§Œ ê°€ë¡œì±„ì—¬ì ¸ì„œ ì²˜ë¦¬ê°€ ì¡°ê¸ˆ í—·ê¹”ë ¸ë‹¤. 





[...nextauth.js]
```js
/* eslint-disable */
import axios from 'axios';
import NextAuth from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';


const createOptions = (req) => ({
    providers: [
        CredentialsProvider({
            name: 'Credentials',
            credentials: {
                userEmail: {label: 'Email', type: 'text', placeholder: 'jsmith'},
                userPw: {label: 'Password', type: 'password'},
            },
            async authorize(credentials, req) {
                // console.log('req :: ', req)
                const apiUrl = process.env.NEXTAUTH_API_URL;
                const u = await axios
                    .post(`${apiUrl}/login-service/user/signIn`, {
                        userEmail: req.body.userEmail,
                        userPw: req.body.userPw,
                    })
                    .then((response => {
                        const user = response.data;
                        // console.log("user :: ", user)
                        return user;
                    }))
                    .catch((error) => {
                        console.log('error :: ', error);
                        throw new Error(JSON.stringify(error.response.data.code));
                    }) || null;
                return u;
            },
        }),
    ],
    pages: {
        signIn: '/login',
        error: '/loginError',
    },
    session: {
        strategy: 'jwt',
    },
    secret: process.env.NEXTAUTH_SECRET,

    callbacks: {
        jwt: async ({token, account, user, req}) => {
            if (account) {
                // ë¡œê·¸ì¸ ì‹œì—ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤. ë‹¤ìŒì— í˜¸ì¶œí•  ë•Œë§ˆë‹¤ ì´ ë¶€ë¶„ì„ ê±´ë„ˆëœë‹ˆë‹¤.
                token.account = {
                    ...account,
                    accessToken: user.accessToken,
                    refreshToken: user.refreshToken
                };
            }
            return token;
        },
        session: async ({session, token}) => {
            // @ts-ignore
            session.accessToken = token.account.accessToken;
            session.refreshToken = token.account.refreshToken;
            console.log('session :: ', session);
            return session;
        },
    },
});

export default async (req, res) => {
    return NextAuth(req, res, createOptions(req));
};
```

<hr/>


axiosConfig.ts

```js
'use client';

import { useEffect } from 'react';

import axios from 'axios';
import { getSession, useSession } from 'next-auth/react';
// axios.defaults.baseURL = process.env.NODE_ENV === 'development' ? '' : process.env.NEXT_PUBLIC_API_BASE_URL;
// axios.defaults.baseURL = process.env.API_URL;

const axiosAuth = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_BASE_URL,
});

const useRefreshToken = () => {
  const { data: session } = useSession();
  const refreshToken = async () => {
    console.log('3ë¦¬í”„ë ˆì‹œ ì‹¤í–‰');
    const res = await axiosAuth.post(
      `/login-service/auth/refresh`, // token refresh api
      { refreshToken: session.refreshToken },
      { headers: { Authorization: `Bearer ${session.accessToken}` } }
    );
    // refresh ê²°ê³¼ëŠ” 2 response ê²°ê³¼ë¡œ ì°íŒë‹¤
    if (session) {
      console.log('3 refreshì´í›„ session?', session);
    }
  };
  return refreshToken;
};

export const useAxiosAuth = () => {
  const { data: session } = useSession();
  const refreshToken = useRefreshToken();

  useEffect(() => {
    // ìš”ì²­ ì¸í„°ì…‰í„°
    const requestIntercept = axiosAuth.interceptors.request.use(
      (config) => {
        if (!config.headers.Authorization) {
          console.log('1ìš”ì²­ ë³´ë‚´ëŠ” session', session);
          console.log('1ìš”ì²­ ë³´ë‚´ëŠ” accessToken', session.accessToken);
          config.headers.Authorization = `${session.accessToken}`;
        }
        return config;
      },
      (error) => {
        console.log('1 interceptor request error', error);
        Promise.reject(error);
      }
    );

    // ì‘ë‹µ ì¸í„°ì…‰í„°
    const responseIntercept = axiosAuth.interceptors.response.use(
      (response) => {
        console.log('2 Interceptors response', response);

        // ì¬ë°œí–‰ ë°›ì€ í† í° ë®ì–´ì“°ê¸°
        if (response?.data?.massage?.includes('ì¬ë°œí–‰')) {
          session.accessToken = response.data.data;
        }

        return response;
      },
      async (error) => {
        const prevRequest = error?.config;
        if (error?.response?.status === 401 && !prevRequest?.sent) {
          prevRequest.sent = true;
          await refreshToken();
          prevRequest.headers.Authorization = `${session?.accessToken}`;
          return axiosAuth(prevRequest);
        }
        return Promise.reject(error);
      }
    );

    return () => {
      axiosAuth.interceptors.request.eject(requestIntercept);
      axiosAuth.interceptors.response.eject(responseIntercept);
    };
  }, [session, refreshToken]);

  return axiosAuth;
};

export default axiosAuth;

```


<hr/>



test.tsx

```useAxiosAuth```ë¥¼ importí•˜ì—¬ ì“°ê³ ,
```  const axiosAuth = useAxiosAuth(); ```  ë¡œ ì‚¬ìš©í•œë‹¤.
ë°”ë¡œ useAxiosAuthë¥¼ ì…ë ¥í•˜ì—¬ ì¼ë”ë‹ˆ ì•ˆëœë‹¤. 


```js


'use client';

import React, { useState } from 'react';
import { useAxiosAuth } from '~/services/axiosConfig';
 import { useSession } from 'next-auth/react';

const Test = () => {
  const axiosAuth = useAxiosAuth();
  const { data: session } = useSession();

  const [userData, setUserData] = useState();
  console.log('TESTpage session', session);

  const getUserInfo = () => {
    console.log('í´ë¦­');
    axiosAuth({
      method: 'post',
      url: '/login-service/userInfo/getUserInfo',
    })
      .then((response) => {
        console.log('test response', response);
        setUserData(response.data.data);
      })
      .catch((err) => {
        console.log('test err', err);
      });
  };

  console.log('userData', userData);

  function Comp({ item }) {
    return <p>{item.userEmail}</p>;
  }

  return (
    <>
      <a onClick={getUserInfo}>getUserInfo</a>
    </>
  );
};
export default Test;

```
